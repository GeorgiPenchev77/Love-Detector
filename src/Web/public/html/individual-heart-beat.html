<!DOCTYPE html>
<html>
  <head>
    <title>Individual heartbeat</title>
    <link rel="icon" href="heart-png.webp" type="image/x-icon" />
    <link rel="stylesheet" href="./css/individual-heart-beat-style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet">
    />
  </head>

  <body>
    <div class="heading-container">
      <h1>Measure your individual heartbeat!</h1>
      <h3>
        Each participant will now get their normal individual heartbeat
        measured.
      </h3>
    </div>
    <div class="middle-container">
      <div class="users">
        <div class="user-container" id="user1">
          <h2><span id="displayUserName1"></span></h2>
          <p><span id="displayUserPronouns1"></span></p>
          <div class="instruction-container">
            <p>1: Remove any accessories from your ear</p>
            <br />
            <p>2: Attach the ear-clip to your earbud</p>
            <br />
            <p>
              3: Press the RIGHT button on the terminal to start the heartbeat
              sensor
            </p>
          </div>
        </div>
        <div class="user-container" id="user2">
          <h2><span id="displayUserName2"></span></h2>
          <p><span id="displayUserPronouns2"></span></p>
          <div class="instruction-container">
            <p>1: Remove any accessories from your ear</p>
            <br />
            <p>2: Attach the ear-clip to your earbud</p>
            <br />
            <p>
              3: Press the RIGHT button on the terminal to start the heartbeat
              sensor
            </p>
          </div>
        </div>
        <div class="nextUserButton-container">
          <button id="nextUserButton">Next User</button>
        </div>
      </div>
    </div>
    <div class="navigationButton-container">
      <button type="button" class="back-button" onclick="goBack()">Back</button>
      <a class="next-button" href="./start-date-page.html">
        <img src="./assets/images/Next-Button.png" alt="Continue" height="50" />
      </a>
    </div>
  </body>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>


  //retrieve user info from server.   
  async function getUserdata(){
    
    const response = await fetch("/getUserData", {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      },
    }) 

    if (!response.ok) {
        throw new Error("Failed to retrieve user data.");
    }
    const userData = await response.json();

    
    console.log("User data:", userData);
    let userName1 = userData.users[0].username;
    let userName2 = userData.users[1].username;
    let userPronouns1 = userData.users[0].pronouns;
    let userPronouns2 = userData.users[1].pronouns;

    document.getElementById("displayUserName1").textContent = userName1;
    document.getElementById("displayUserPronouns1").textContent = userPronouns1;
    document.getElementById("displayUserName2").textContent = userName2;
    document.getElementById("displayUserPronouns2").textContent = userPronouns2;

    //show only container with user 1 first.
    document.getElementById("user1").style.display = "block";
    document.getElementById("user2").style.display = "none";
    document.getElementById("nextUserButton").style.display = "none";
  }
  getUserdata(); 

    function goBack() {
      window.history.back();
    }

    const socket = io();

    socket.on("measuringMessage", function (data) {
      console.log("Received measuringMessage event");
      displayMeasureMessage("user1");
    });

    // Toggle visibility of user containers
    document
      .getElementById("nextUserButton")
      .addEventListener("click", function () {
        document.getElementById("user1").style.display = "none";
        document.getElementById("user2").style.display = "block";
        document.getElementById("nextUserButton").style.display = "none";

        socket.on("measuringMessage", function (data) {
          console.log("Received measuringMessage event");
          displayMeasureMessage("user2");
        });
      });

    /*function for displaying a waiting message while each user is measuring heartbeat,
     then after measurement is done, the users normal heartbeat is displayed. */
    function displayMeasureMessage(userId) {
      var userContainer = document.getElementById(userId);

      //hide the instructions while the measuring process is running.
      var instructionContainer = userContainer.querySelector(
        ".instruction-container"
      );
      instructionContainer.style.display = "none";

      var messageParagraph = document.createElement("p");
      messageParagraph.textContent = "Measuring heartbeat...";
      messageParagraph.classList.add("message-text"); // Add a class for CSS to style the text
      userContainer.appendChild(messageParagraph);

      //hide the  nextUserButton while the measuring process is running.
      document.getElementById("nextUserButton").style.display = "none";

      setTimeout(function () {
        messageParagraph.textContent = "heartbeat: X";

        if (userId == "user1") {
          document.getElementById("nextUserButton").style.display = "block";
        } else {
          document.getElementById("nextUserButton").style.display = "none";
        }
      }, 5000);
    }
  </script>
</html>
